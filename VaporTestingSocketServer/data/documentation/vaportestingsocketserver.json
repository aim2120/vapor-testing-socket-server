{"schemaVersion":{"minor":3,"patch":0,"major":0},"metadata":{"modules":[{"name":"VaporTestingSocketServer"}],"roleHeading":"Framework","role":"collection","symbolKind":"module","externalID":"VaporTestingSocketServer","title":"VaporTestingSocketServer"},"kind":"symbol","identifier":{"interfaceLanguage":"swift","url":"doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer"},"abstract":[{"type":"text","text":"A supplement to "},{"code":"VaporTesting","type":"codeVoice"},{"type":"text","text":" to work with an application over UNIX domain sockets (UDS)."}],"hierarchy":{"paths":[[]]},"primaryContentSections":[{"kind":"content","content":[{"anchor":"Overview","type":"heading","level":2,"text":"Overview"},{"inlineContent":[{"text":"The ","type":"text"},{"type":"reference","identifier":"https:\/\/github.com\/vapor\/vapor","isActive":true},{"text":" library already ships with a very useful ","type":"text"},{"code":"VaporTesting","type":"codeVoice"},{"text":" library that supports “in-memory” and “live” TCP server testing.","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"However, this SDK does not support server testing over UDS."},{"text":" ","type":"text"},{"text":"This package was created to fill this need.","type":"text"}],"type":"paragraph"},{"content":[{"inlineContent":[{"text":"This library is only available for use in Debug builds.","type":"text"},{"type":"text","text":" "},{"text":"This is due to the need to use a ","type":"text"},{"code":"@testable","type":"codeVoice"},{"text":" import for the ","type":"text"},{"type":"codeVoice","code":"VaporTesting"},{"text":" library target.","type":"text"},{"type":"text","text":" "},{"text":"Feel free to open an issue if this is problematic for your own usage.","type":"text"}],"type":"paragraph"}],"style":"note","type":"aside","name":"Note"},{"level":3,"anchor":"Why-use-UDS-for-Vapor-server-testing","text":"Why use UDS for Vapor server testing?","type":"heading"},{"type":"paragraph","inlineContent":[{"text":"When testing a Vapor server, there’s often a need to stub requests made to endpoints made to external services.","type":"text"},{"type":"text","text":" "},{"text":"One easy way to achieve this is to create a ","type":"text"},{"type":"codeVoice","code":"RouteCollection"},{"type":"text","text":" for that external service for testing purposes and add it to the application being unit tested."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"This means of stubbing an external service is not possible when using the “in-memory” testing application (which is the default behavior for "},{"type":"codeVoice","code":"VaporTesting"},{"type":"text","text":")."},{"text":" ","type":"text"},{"type":"text","text":"Attempting to do so will result in “connection refused” when attempting to make requests to these external service via an "},{"code":"HTTPClient","type":"codeVoice"},{"text":".","type":"text"},{"type":"text","text":" "},{"type":"text","text":"It is possible to stub this way when using a TCP connection (e.g. a "},{"code":"localhost","type":"codeVoice"},{"text":" server).","type":"text"}]},{"inlineContent":[{"type":"text","text":"However, there is a more efficient way to achieve this type of stubbing with UNIX domain sockets."},{"text":" ","type":"text"},{"type":"text","text":"UDS allow for inter-process communication to occur on the same operating system."},{"type":"text","text":" "},{"text":"Communicating over UDS is more efficient than communicating over TCP.","type":"text"}],"type":"paragraph"},{"anchor":"How-do-I-use-this-SDK","type":"heading","level":3,"text":"How do I use this SDK?"},{"inlineContent":[{"type":"text","text":"This SDK was designed to work alongside the "},{"code":"VaporTesting","type":"codeVoice"},{"text":" library.","type":"text"}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Let’s say we have server that sends alerts to some endpoint whenever it receives a message."},{"type":"text","text":" "},{"text":"For simplicity, I will only show the ","type":"text"},{"type":"codeVoice","code":"RouteCollection"},{"type":"text","text":" for the application."},{"type":"text","text":" "},{"text":"Otherwise, assume it’s a normative Vapor application.","type":"text"}]},{"type":"codeListing","syntax":"swift","code":["import Vapor","","struct MessageRouteController: RouteCollection {","    let alertBaseURL: URL","","    func boot(routes: any RoutesBuilder) throws {","        routes.post(\"message\", use: { req async throws in","            let message = req.body.string ?? \"\"","            do {","                let alertEndpoint = alertBaseURL.appending(path: \"alert\").absoluteString","                let res = try await req.client.post(URI(string: alertEndpoint), content: message)","                return res.status","            } catch {","                return HTTPResponseStatus.internalServerError","            }","        })","    }","}"]},{"inlineContent":[{"type":"text","text":"In our tests, we will define a stub "},{"type":"codeVoice","code":"RouteCollection"},{"type":"text","text":" for the external alerting service."},{"text":" ","type":"text"},{"text":"The stub service will return either ","type":"text"},{"type":"codeVoice","code":"200"},{"type":"text","text":" or "},{"type":"codeVoice","code":"400"},{"type":"text","text":", depending on the content of the message."}],"type":"paragraph"},{"type":"codeListing","syntax":"swift","code":["import Vapor","","struct StubAlertRouteController: RouteCollection {","    func boot(routes: any RoutesBuilder) throws {","        routes.post(\"alert\", use: { req async throws in","            let message = req.body.string ?? \"\"","            switch message {","            case \"stub_ok\": return HTTPResponseStatus.ok","            default: return HTTPResponseStatus.badRequest","            }","        })","    }","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"We’ll then perform the following steps in our test functions:"}]},{"type":"orderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"Create a testing application using "},{"type":"codeVoice","code":"VaporTesting.withApp"},{"text":".","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Create a "},{"code":"TemporarySocket","type":"codeVoice"},{"text":" using ","type":"text"},{"code":"withTemporarySocket","type":"codeVoice"},{"type":"text","text":" to use during testing (this is the UDS we’ll be communicating over)."}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Setup the routes, making use to use the socket URL for the stubbed service route.","type":"text"}]}]},{"content":[{"inlineContent":[{"text":"Finally, test the application using the ","type":"text"},{"type":"codeVoice","code":"testing"},{"type":"text","text":" API to specify UDS."}],"type":"paragraph"}]}]},{"syntax":"swift","code":["import Testing","import Vapor","import VaporTesting","import VaporTestingSocketServer","","@Test","func messageReturnsOkOnSuccessfulAlert() async throws {","    \/\/ (1)","    try await VaporTesting.withApp { app in","        \/\/ (2)","        try await withTemporarySocket { tempSocket in ","            \/\/ (3)","            try app.register(collection: MessageRouteController(alertBaseURL: tempSocket.url))","            try app.register(collection: StubAlertRouteController())","","            \/\/ (4)","            try await app.testing(method: .unixDomainSocket(path: tempSocket.path))","                .test(.POST, \"message\", beforeResponse: { res async throws in ","                    try req.body.writeString(\"stub_ok\", encoding: .utf8)","                }, afterResponse: { res async throws in","                    #expect(res.status == .ok)","                })","        }","    }","}"],"type":"codeListing"}]}],"variants":[{"paths":["\/documentation\/vaportestingsocketserver"],"traits":[{"interfaceLanguage":"swift"}]}],"sections":[],"topicSections":[{"title":"Create Socket","identifiers":["doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer\/withTemporarySocket(function:_:)-52exl","doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer\/withTemporarySocket(function:_:)-43u4g","doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer\/TemporarySocket","doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer\/TemporarySocketError"],"anchor":"Create-Socket"},{"anchor":"Test-Application","title":"Test Application","identifiers":["doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer\/Vapor\/Application\/testing(method:)","doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer\/Vapor\/Application\/SocketServerMethod"]}],"references":{"doc://VaporTestingSocketServer/documentation/VaporTestingSocketServer/TemporarySocket":{"kind":"symbol","type":"topic","fragments":[{"text":"struct","kind":"keyword"},{"kind":"text","text":" "},{"kind":"identifier","text":"TemporarySocket"}],"role":"symbol","navigatorTitle":[{"text":"TemporarySocket","kind":"identifier"}],"abstract":[{"text":"A representation of a temporary UNIX domain socket for testing purposes.","type":"text"}],"url":"\/documentation\/vaportestingsocketserver\/temporarysocket","title":"TemporarySocket","identifier":"doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer\/TemporarySocket"},"doc://VaporTestingSocketServer/documentation/VaporTestingSocketServer/withTemporarySocket(function:_:)-43u4g":{"identifier":"doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer\/withTemporarySocket(function:_:)-43u4g","abstract":[{"type":"text","text":"Creates a temporary UNIX domain socket for usage within the passed closure’s scope."}],"role":"symbol","fragments":[{"kind":"keyword","text":"func"},{"kind":"text","text":" "},{"kind":"identifier","text":"withTemporarySocket"},{"kind":"text","text":"<"},{"text":"O","kind":"genericParameter"},{"text":">(","kind":"text"},{"text":"function","kind":"externalParam"},{"kind":"text","text":": "},{"preciseIdentifier":"s:SS","text":"String","kind":"typeIdentifier"},{"text":", (","kind":"text"},{"kind":"keyword","text":"inout"},{"kind":"text","text":" "},{"kind":"typeIdentifier","text":"TemporarySocket","preciseIdentifier":"s:24VaporTestingSocketServer09TemporaryC0V"},{"kind":"text","text":") "},{"text":"async","kind":"keyword"},{"kind":"text","text":" "},{"kind":"keyword","text":"throws"},{"text":" -> ","kind":"text"},{"text":"O","kind":"typeIdentifier"},{"text":") ","kind":"text"},{"text":"async","kind":"keyword"},{"kind":"text","text":" "},{"kind":"keyword","text":"throws"},{"text":" -> ","kind":"text"},{"kind":"typeIdentifier","text":"O"}],"kind":"symbol","type":"topic","url":"\/documentation\/vaportestingsocketserver\/withtemporarysocket(function:_:)-43u4g","title":"withTemporarySocket(function:_:)"},"doc://VaporTestingSocketServer/documentation/VaporTestingSocketServer/Vapor/Application/SocketServerMethod":{"fragments":[{"kind":"keyword","text":"enum"},{"kind":"text","text":" "},{"kind":"identifier","text":"SocketServerMethod"}],"role":"symbol","url":"\/documentation\/vaportestingsocketserver\/vapor\/application\/socketservermethod","kind":"symbol","identifier":"doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer\/Vapor\/Application\/SocketServerMethod","navigatorTitle":[{"text":"SocketServerMethod","kind":"identifier"}],"abstract":[{"text":"Testing method for socket servers.","type":"text"}],"title":"Application.SocketServerMethod","type":"topic"},"doc://VaporTestingSocketServer/documentation/VaporTestingSocketServer/withTemporarySocket(function:_:)-52exl":{"identifier":"doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer\/withTemporarySocket(function:_:)-52exl","abstract":[{"text":"Creates a temporary UNIX domain socket for usage within the passed closure’s scope.","type":"text"}],"role":"symbol","fragments":[{"text":"func","kind":"keyword"},{"text":" ","kind":"text"},{"text":"withTemporarySocket","kind":"identifier"},{"kind":"text","text":"<"},{"kind":"genericParameter","text":"O"},{"text":">(","kind":"text"},{"kind":"externalParam","text":"function"},{"kind":"text","text":": "},{"kind":"typeIdentifier","preciseIdentifier":"s:SS","text":"String"},{"kind":"text","text":", ("},{"text":"inout","kind":"keyword"},{"text":" ","kind":"text"},{"preciseIdentifier":"s:24VaporTestingSocketServer09TemporaryC0V","text":"TemporarySocket","kind":"typeIdentifier"},{"kind":"text","text":") "},{"text":"throws","kind":"keyword"},{"text":" -> ","kind":"text"},{"kind":"typeIdentifier","text":"O"},{"kind":"text","text":") "},{"kind":"keyword","text":"throws"},{"kind":"text","text":" -> "},{"kind":"typeIdentifier","text":"O"}],"kind":"symbol","type":"topic","url":"\/documentation\/vaportestingsocketserver\/withtemporarysocket(function:_:)-52exl","title":"withTemporarySocket(function:_:)"},"doc://VaporTestingSocketServer/documentation/VaporTestingSocketServer/Vapor/Application/testing(method:)":{"role":"symbol","fragments":[{"kind":"keyword","text":"func"},{"kind":"text","text":" "},{"text":"testing","kind":"identifier"},{"text":"(","kind":"text"},{"text":"method","kind":"externalParam"},{"kind":"text","text":": "},{"kind":"typeIdentifier","preciseIdentifier":"s:5Vapor11ApplicationC","text":"Application"},{"kind":"text","text":"."},{"text":"SocketServerMethod","preciseIdentifier":"s:5Vapor11ApplicationC0A19TestingSocketServerE0dE6MethodO","kind":"typeIdentifier"},{"text":") ","kind":"text"},{"kind":"keyword","text":"throws"},{"kind":"text","text":" -> any "},{"preciseIdentifier":"s:12VaporTesting0B17ApplicationTesterP","kind":"typeIdentifier","text":"TestingApplicationTester"}],"abstract":[{"text":"Returns an application tester for the passed server testing method.","type":"text"}],"kind":"symbol","title":"testing(method:)","url":"\/documentation\/vaportestingsocketserver\/vapor\/application\/testing(method:)","identifier":"doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer\/Vapor\/Application\/testing(method:)","type":"topic"},"doc://VaporTestingSocketServer/documentation/VaporTestingSocketServer/TemporarySocketError":{"kind":"symbol","type":"topic","fragments":[{"text":"enum","kind":"keyword"},{"text":" ","kind":"text"},{"text":"TemporarySocketError","kind":"identifier"}],"role":"symbol","navigatorTitle":[{"text":"TemporarySocketError","kind":"identifier"}],"abstract":[{"text":"Errors that may be thrown when attempting to create a ","type":"text"},{"type":"reference","isActive":true,"identifier":"doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer\/TemporarySocket"},{"type":"text","text":"."}],"url":"\/documentation\/vaportestingsocketserver\/temporarysocketerror","title":"TemporarySocketError","identifier":"doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer\/TemporarySocketError"},"doc://VaporTestingSocketServer/documentation/VaporTestingSocketServer":{"kind":"symbol","type":"topic","role":"collection","abstract":[{"type":"text","text":"A supplement to "},{"type":"codeVoice","code":"VaporTesting"},{"text":" to work with an application over UNIX domain sockets (UDS).","type":"text"}],"url":"\/documentation\/vaportestingsocketserver","title":"VaporTestingSocketServer","identifier":"doc:\/\/VaporTestingSocketServer\/documentation\/VaporTestingSocketServer"},"https://github.com/vapor/vapor":{"url":"https:\/\/github.com\/vapor\/vapor","type":"link","title":"Vapor","titleInlineContent":[{"type":"text","text":"Vapor"}],"identifier":"https:\/\/github.com\/vapor\/vapor"}}}